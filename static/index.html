<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ZeroClaw Command Center</title>
<style>
:root {
  --bg: #0f1117;
  --bg-card: #161822;
  --bg-input: #1c1f2e;
  --border: #2a2d3e;
  --text: #e1e4ed;
  --text-dim: #8b8fa3;
  --green: #3dd68c;
  --red: #f5555d;
  --yellow: #e5c07b;
  --orange: #d19a66;
  --blue: #61afef;
  --purple: #c678dd;
  --radius: 6px;
  --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  --mono: 'SF Mono', 'Cascadia Code', 'Consolas', 'Liberation Mono', monospace;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; }
body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  line-height: 1.5;
}
a { color: var(--blue); text-decoration: none; }
a:hover { text-decoration: underline; }

/* Layout */
.header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 24px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-card);
}
.header h1 { font-size: 16px; font-weight: 600; }
.header h1 span { color: var(--green); }
.header-right { font-size: 13px; color: var(--text-dim); }
.main { padding: 24px; max-width: 1400px; margin: 0 auto; }

/* Cards grid */
.cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 16px;
}
.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  cursor: pointer;
  transition: border-color 0.15s;
}
.card:hover { border-color: var(--text-dim); }
.card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.card-name { font-size: 15px; font-weight: 600; }
.card-meta { font-size: 13px; color: var(--text-dim); margin-top: 8px; }
.card-meta span { margin-right: 16px; }

/* Status badge */
.status {
  display: inline-flex; align-items: center; gap: 6px;
  font-size: 12px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;
}
.status::before {
  content: ''; display: inline-block; width: 8px; height: 8px; border-radius: 50%;
}
.status-running { color: var(--green); }
.status-running::before { background: var(--green); }
.status-stopped { color: var(--red); }
.status-stopped::before { background: var(--red); }
.status-stale-pid { color: var(--yellow); }
.status-stale-pid::before { background: var(--yellow); }
.status-dead { color: var(--orange); }
.status-dead::before { background: var(--orange); }
.status-unknown { color: var(--text-dim); }
.status-unknown::before { background: var(--text-dim); }

/* Buttons */
.btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 6px 14px; border: 1px solid var(--border);
  border-radius: var(--radius); background: var(--bg-input);
  color: var(--text); font-size: 13px; font-family: var(--font);
  cursor: pointer; transition: background 0.15s, border-color 0.15s;
}
.btn:hover { border-color: var(--text-dim); }
.btn:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-start { border-color: var(--green); color: var(--green); }
.btn-start:hover { background: rgba(61,214,140,0.1); }
.btn-stop { border-color: var(--red); color: var(--red); }
.btn-stop:hover { background: rgba(245,85,93,0.1); }
.btn-restart { border-color: var(--yellow); color: var(--yellow); }
.btn-restart:hover { background: rgba(229,192,123,0.1); }
.btn-primary { border-color: var(--blue); color: var(--blue); }
.btn-primary:hover { background: rgba(97,175,239,0.1); }
.btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

/* Instance detail layout */
.instance-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 20px; flex-wrap: wrap; gap: 12px;
}
.instance-title { display: flex; align-items: center; gap: 12px; }
.instance-title h2 { font-size: 20px; font-weight: 600; }
.back-link { font-size: 13px; color: var(--text-dim); }

/* Tabs */
.tabs {
  display: flex; gap: 0; border-bottom: 1px solid var(--border);
  margin-bottom: 20px;
}
.tab {
  padding: 8px 16px; font-size: 13px; color: var(--text-dim);
  cursor: pointer; border-bottom: 2px solid transparent;
  transition: color 0.15s, border-color 0.15s;
  background: none; border-top: none; border-left: none; border-right: none;
  font-family: var(--font);
}
.tab:hover { color: var(--text); }
.tab.active { color: var(--blue); border-bottom-color: var(--blue); }

/* Panels */
.panel {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
}
.panel-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 16px;
}
.panel-title { font-size: 14px; font-weight: 600; }

/* Detail rows */
.detail-grid {
  display: grid;
  grid-template-columns: 140px 1fr;
  gap: 8px 16px;
  font-size: 14px;
}
.detail-label { color: var(--text-dim); }
.detail-value { font-family: var(--mono); font-size: 13px; }

/* Log viewer */
.log-viewer {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px;
  font-family: var(--mono);
  font-size: 12px;
  line-height: 1.6;
  max-height: 600px;
  overflow-y: auto;
  white-space: pre-wrap;
  word-break: break-all;
  color: var(--text-dim);
}

/* Config editor */
.config-editor {
  width: 100%;
  min-height: 400px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px;
  font-family: var(--mono);
  font-size: 13px;
  line-height: 1.6;
  color: var(--text);
  resize: vertical;
}
.config-editor:focus { outline: 1px solid var(--blue); border-color: var(--blue); }

/* Notifications */
.notify {
  padding: 10px 16px;
  border-radius: var(--radius);
  font-size: 13px;
  margin-bottom: 12px;
}
.notify-success { background: rgba(61,214,140,0.1); border: 1px solid var(--green); color: var(--green); }
.notify-error { background: rgba(245,85,93,0.1); border: 1px solid var(--red); color: var(--red); }
.notify-warn { background: rgba(229,192,123,0.1); border: 1px solid var(--yellow); color: var(--yellow); }
.notify-info { background: rgba(97,175,239,0.1); border: 1px solid var(--blue); color: var(--blue); }

/* Diff panel */
.diff-panel {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px;
  font-family: var(--mono);
  font-size: 12px;
  margin-top: 12px;
}
.diff-change { color: var(--yellow); }
.diff-add { color: var(--green); }
.diff-remove { color: var(--red); }

/* Table */
.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
.data-table th {
  text-align: left; padding: 8px 12px;
  border-bottom: 1px solid var(--border);
  color: var(--text-dim); font-weight: 500;
  font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;
}
.data-table td {
  padding: 8px 12px;
  border-bottom: 1px solid var(--border);
}
.data-table tr:last-child td { border-bottom: none; }

/* Usage stats */
.usage-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 16px;
}
.usage-stat {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
}
.usage-stat-label { font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
.usage-stat-value { font-size: 24px; font-weight: 600; margin-top: 4px; font-family: var(--mono); }

/* Loading */
.loading { color: var(--text-dim); font-size: 14px; padding: 20px 0; }
.empty-state { color: var(--text-dim); font-size: 14px; padding: 40px 0; text-align: center; }

/* Conflict dialog */
.conflict-dialog {
  background: var(--bg-card);
  border: 2px solid var(--yellow);
  border-radius: var(--radius);
  padding: 20px;
  margin-top: 12px;
}
.conflict-dialog h3 { color: var(--yellow); font-size: 14px; margin-bottom: 8px; }
.conflict-dialog p { font-size: 13px; color: var(--text-dim); margin-bottom: 12px; }

/* Window select */
.window-select {
  display: flex; gap: 4px;
}
.window-btn {
  padding: 4px 12px; font-size: 12px;
  background: var(--bg-input); border: 1px solid var(--border);
  border-radius: var(--radius); color: var(--text-dim);
  cursor: pointer; font-family: var(--font);
}
.window-btn.active { border-color: var(--blue); color: var(--blue); }

/* Pagination */
.pagination {
  display: flex; align-items: center; gap: 12px;
  margin-top: 12px; font-size: 13px; color: var(--text-dim);
}

/* Modal overlay */
.modal-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6); z-index: 100;
  display: flex; align-items: center; justify-content: center;
}
.modal {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 24px;
  min-width: 400px; max-width: 500px; width: 90%;
}
.modal h3 { font-size: 16px; margin-bottom: 16px; }
.modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px; }

/* Form inputs */
.form-group { margin-bottom: 14px; }
.form-label { display: block; font-size: 13px; color: var(--text-dim); margin-bottom: 4px; }
.form-input {
  width: 100%; padding: 8px 12px;
  background: var(--bg-input); border: 1px solid var(--border);
  border-radius: var(--radius); color: var(--text);
  font-family: var(--mono); font-size: 13px;
}
.form-input:focus { outline: none; border-color: var(--blue); }
.form-hint { font-size: 11px; color: var(--text-dim); margin-top: 2px; }

/* Danger button */
.btn-danger { border-color: var(--red); color: var(--red); }
.btn-danger:hover { background: rgba(245,85,93,0.1); }
.btn-archive { border-color: var(--orange); color: var(--orange); }
.btn-archive:hover { background: rgba(209,154,102,0.1); }
.btn-clone { border-color: var(--purple); color: var(--purple); }
.btn-clone:hover { background: rgba(198,120,221,0.1); }

/* Archived badge */
.status-archived { color: var(--text-dim); }
.status-archived::before { background: var(--text-dim); }

/* Archived card */
.card-archived { opacity: 0.6; border-style: dashed; }
.card-archived:hover { opacity: 0.85; }

/* Dashboard toolbar */
.dashboard-toolbar {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 16px; gap: 12px; flex-wrap: wrap;
}
.toolbar-right { display: flex; align-items: center; gap: 12px; }

/* Checkbox toggle */
.toggle-label {
  display: flex; align-items: center; gap: 6px;
  font-size: 13px; color: var(--text-dim); cursor: pointer;
}
.toggle-label input { cursor: pointer; }

/* Filter bar */
.filter-bar {
  display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end;
  background: var(--bg); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 12px;
  margin-bottom: 16px;
}
.filter-field { display: flex; flex-direction: column; gap: 2px; }
.filter-field label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
.filter-field input,
.filter-field select {
  padding: 6px 10px; background: var(--bg-input); border: 1px solid var(--border);
  border-radius: var(--radius); color: var(--text); font-family: var(--mono); font-size: 12px;
}
.filter-field input:focus, .filter-field select:focus { outline: none; border-color: var(--blue); }

/* Subtab toggle */
.subtab-bar { display: flex; gap: 4px; margin-bottom: 16px; }
.subtab {
  padding: 6px 16px; font-size: 13px; font-family: var(--font);
  background: var(--bg-input); border: 1px solid var(--border);
  border-radius: var(--radius); color: var(--text-dim); cursor: pointer;
}
.subtab.active { border-color: var(--blue); color: var(--blue); }

/* Inline event detail */
.event-detail-row td { padding: 0 !important; border-bottom: 1px solid var(--border); }
.event-detail-content {
  padding: 16px 20px; background: var(--bg);
  border-top: 1px solid var(--border);
}
.event-detail-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 12px;
}

/* Flow status badges */
.status-completed { color: var(--green); }
.status-completed::before { background: var(--green); }
.status-timed-out { color: var(--yellow); }
.status-timed-out::before { background: var(--yellow); }
.status-force-completed { color: var(--orange); }
.status-force-completed::before { background: var(--orange); }
.status-active { color: var(--blue); }
.status-active::before { background: var(--blue); }

/* Clickable rows */
.data-table tr.clickable { cursor: pointer; }
.data-table tr.clickable:hover td { background: rgba(97,175,239,0.05); }
</style>
</head>
<body>

<div class="header">
  <h1><span>Zero</span>Claw <span style="color:var(--text-dim);font-weight:400;font-size:13px;">Command Center</span></h1>
  <div class="header-right" id="health-status"></div>
</div>
<div class="main" id="app"></div>

<script>
'use strict';

// ── State ────────────────────────────────────────────────────────
const state = {
  view: 'dashboard',
  instance: null,
  instanceArchived: false,
  tab: 'overview',
  instances: [],
  refreshTimer: null,
  abortController: null,
  configEtag: null,
  routeGeneration: 0,
  showArchived: false,
  expandedEventId: null,
  flowSubTab: 'active',
};

// ── DOM helpers (XSS-safe) ───────────────────────────────────────
function h(tag, attrs) {
  const el = document.createElement(tag);
  if (attrs) {
    for (const [k, v] of Object.entries(attrs)) {
      if (k === 'className') el.className = v;
      else if (k === 'textContent') el.textContent = v;
      else if (k.startsWith('on')) el.addEventListener(k.slice(2).toLowerCase(), v);
      else el.setAttribute(k, v);
    }
  }
  for (let i = 2; i < arguments.length; i++) {
    const child = arguments[i];
    if (child == null) continue;
    if (typeof child === 'string') el.appendChild(document.createTextNode(child));
    else if (child instanceof Node) el.appendChild(child);
  }
  return el;
}

function clear(el) { while (el.firstChild) el.removeChild(el.firstChild); }

function statusClass(s) {
  if (s === 'running') return 'status-running';
  if (s === 'stopped') return 'status-stopped';
  if (s === 'stale-pid') return 'status-stale-pid';
  if (s === 'dead') return 'status-dead';
  if (s === 'archived') return 'status-archived';
  if (s === 'completed') return 'status-completed';
  if (s === 'timed_out') return 'status-timed-out';
  if (s === 'force_completed') return 'status-force-completed';
  if (s === 'active') return 'status-active';
  return 'status-unknown';
}

function fmtNum(n) {
  if (n == null) return '-';
  return n.toLocaleString();
}

function fmtDuration(ms) {
  if (ms == null) return '-';
  if (ms < 1000) return ms + 'ms';
  return (ms / 1000).toFixed(1) + 's';
}

function fmtTime(ts) {
  if (!ts) return '-';
  try {
    const d = new Date(ts);
    if (isNaN(d.getTime())) return ts;
    return d.toLocaleString();
  } catch (e) { return ts; }
}

// ── Notifications ────────────────────────────────────────────────
function showNotify(container, type, msg) {
  const existing = container.querySelector('.notify');
  if (existing) existing.remove();
  const n = h('div', { className: 'notify notify-' + type, textContent: msg });
  container.insertBefore(n, container.firstChild);
  if (type === 'success' || type === 'info') {
    setTimeout(function() { if (n.parentNode) n.remove(); }, 4000);
  }
}

// ── Modal helpers ────────────────────────────────────────────────
function showModal(contentEl) {
  closeModal();
  var overlay = h('div', { className: 'modal-overlay', id: 'modal-overlay' });
  overlay.addEventListener('click', function(e) {
    if (e.target === overlay) closeModal();
  });
  overlay.appendChild(contentEl);
  document.body.appendChild(overlay);
}

function closeModal() {
  var existing = document.getElementById('modal-overlay');
  if (existing) existing.remove();
}

function confirmDialog(title, message, confirmLabel, confirmClass, onConfirm) {
  var modal = h('div', { className: 'modal' },
    h('h3', { textContent: title }),
    h('p', { textContent: message, style: 'font-size:13px;color:var(--text-dim);margin-bottom:8px' }),
    h('div', { className: 'modal-actions' },
      h('button', { className: 'btn', textContent: 'Cancel', onClick: closeModal }),
      h('button', { className: 'btn ' + (confirmClass || 'btn-primary'), textContent: confirmLabel, onClick: function() {
        closeModal();
        onConfirm();
      }})
    )
  );
  showModal(modal);
}

function apiErrorMsg(res) {
  if (res.data && res.data.error) return res.data.error;
  return 'Request failed (HTTP ' + res.status + ')';
}

// ── API wrapper ──────────────────────────────────────────────────
async function api(path, opts) {
  opts = opts || {};
  const headers = Object.assign({ 'Content-Type': 'application/json' }, opts.headers || {});
  const resp = await fetch('/api' + path, {
    method: opts.method || 'GET',
    headers: headers,
    body: opts.body ? JSON.stringify(opts.body) : undefined,
    signal: state.abortController ? state.abortController.signal : undefined,
  });
  const ct = resp.headers.get('content-type') || '';
  let data = null;
  if (ct.includes('application/json')) {
    data = await resp.json();
  }
  return { status: resp.status, data: data, headers: resp.headers };
}

// ── Router ───────────────────────────────────────────────────────
function route() {
  if (state.refreshTimer) { clearInterval(state.refreshTimer); state.refreshTimer = null; }
  if (state.abortController) { state.abortController.abort(); }
  state.abortController = new AbortController();
  state.routeGeneration++;
  const gen = state.routeGeneration;

  const hash = location.hash || '#/';
  // Split hash from query: #/instance/name?archived=1 -> parts + query
  var hashAndQuery = hash.replace('#/', '').split('?');
  const parts = hashAndQuery[0].split('/');
  var queryStr = hashAndQuery[1] || '';
  var queryArchived = queryStr.indexOf('archived=1') !== -1;

  if (parts[0] === 'instance' && parts[1]) {
    state.view = 'instance';
    state.instance = decodeURIComponent(parts[1]);
    state.instanceArchived = queryArchived;
    state.tab = parts[2] || 'overview';
    renderInstance(gen);
  } else {
    state.view = 'dashboard';
    state.instance = null;
    state.instanceArchived = false;
    state.tab = 'overview';
    renderDashboard(gen);
  }
}

window.addEventListener('hashchange', route);

// ── Dashboard ────────────────────────────────────────────────────
function instancesApiPath() {
  return '/instances' + (state.showArchived ? '?include_archived=true' : '');
}

async function renderDashboard(gen) {
  const app = document.getElementById('app');
  clear(app);
  app.appendChild(h('div', { className: 'loading', textContent: 'Loading instances...' }));

  try {
    const res = await api(instancesApiPath());
    if (gen !== state.routeGeneration) return;
    if (res.status === 200 && Array.isArray(res.data)) {
      state.instances = res.data;
      paintDashboard();
    } else {
      clear(app);
      var msg = (res.data && res.data.error) || ('Server returned ' + res.status);
      app.appendChild(h('div', { className: 'notify notify-error', textContent: 'Failed to load instances: ' + msg }));
    }
  } catch (e) {
    if (e.name === 'AbortError') return;
    clear(app);
    app.appendChild(h('div', { className: 'notify notify-error', textContent: 'Failed to load instances: ' + e.message }));
  }

  state.refreshTimer = setInterval(async function() {
    try {
      const res = await api(instancesApiPath());
      if (gen !== state.routeGeneration) return;
      if (res.status === 200 && Array.isArray(res.data)) {
        state.instances = res.data;
        paintDashboard();
      }
    } catch (e) {
      if (e.name === 'AbortError') return;
    }
  }, 5000);
}

function paintDashboard() {
  const app = document.getElementById('app');
  clear(app);

  // Notification area
  app.appendChild(h('div', { id: 'dashboard-notify' }));

  // Toolbar
  var archiveCheckbox = h('input', { type: 'checkbox', id: 'show-archived-cb' });
  archiveCheckbox.checked = state.showArchived;
  archiveCheckbox.addEventListener('change', function() {
    state.showArchived = this.checked;
    route();
  });

  var toolbar = h('div', { className: 'dashboard-toolbar' },
    h('button', { className: 'btn btn-primary', textContent: '+ New Instance', onClick: showCreateDialog }),
    h('div', { className: 'toolbar-right' },
      h('label', { className: 'toggle-label' },
        archiveCheckbox,
        'Show archived'
      )
    )
  );
  app.appendChild(toolbar);

  var active = state.instances.filter(function(i) { return !i.archived_at; });
  var archived = state.instances.filter(function(i) { return !!i.archived_at; });

  if (active.length === 0 && archived.length === 0) {
    app.appendChild(h('div', { className: 'empty-state', textContent: 'No instances yet. Click "New Instance" to create one.' }));
    return;
  }

  // Active instances grid
  if (active.length > 0) {
    var grid = h('div', { className: 'cards' });
    for (var inst of active) {
      grid.appendChild(makeInstanceCard(inst, false));
    }
    app.appendChild(grid);
  }

  // Archived instances (only if toggle is on)
  if (archived.length > 0 && state.showArchived) {
    app.appendChild(h('h3', { textContent: 'Archived', style: 'margin-top:24px;margin-bottom:12px;font-size:14px;color:var(--text-dim)' }));
    var archiveGrid = h('div', { className: 'cards' });
    for (var aInst of archived) {
      archiveGrid.appendChild(makeInstanceCard(aInst, true));
    }
    app.appendChild(archiveGrid);
  }
}

function makeInstanceCard(inst, isArchived) {
  var card = h('div', { className: 'card' + (isArchived ? ' card-archived' : ''), onClick: function() {
    location.hash = '#/instance/' + encodeURIComponent(inst.name) + (isArchived ? '?archived=1' : '');
  }},
    h('div', { className: 'card-header' },
      h('span', { className: 'card-name', textContent: inst.name }),
      h('span', { className: 'status ' + statusClass(inst.status), textContent: inst.status })
    ),
    h('div', { className: 'card-meta' },
      h('span', { textContent: 'Port: ' + (inst.port || '-') }),
      inst.pid ? h('span', { textContent: 'PID: ' + inst.pid }) : null,
      isArchived ? h('span', { textContent: 'Archived: ' + fmtTime(inst.archived_at), style: 'color:var(--text-dim)' }) : null
    )
  );
  return card;
}

// ── Create instance dialog ──────────────────────────────────────
function showCreateDialog() {
  var nameInput = h('input', { className: 'form-input', type: 'text', id: 'create-name', placeholder: 'my-agent' });
  var portInput = h('input', { className: 'form-input', type: 'number', id: 'create-port', placeholder: 'Auto-assign' });
  var providerInput = h('input', { className: 'form-input', type: 'text', id: 'create-provider', placeholder: 'openrouter' });
  var modelInput = h('input', { className: 'form-input', type: 'text', id: 'create-model', placeholder: 'anthropic/claude-sonnet-4-20250514' });
  var errorDiv = h('div', { id: 'create-error' });

  var modal = h('div', { className: 'modal' },
    h('h3', { textContent: 'Create Instance' }),
    errorDiv,
    h('div', { className: 'form-group' },
      h('label', { className: 'form-label', textContent: 'Name *' }),
      nameInput,
      h('div', { className: 'form-hint', textContent: 'Letters, digits, hyphens. 1-64 chars.' })
    ),
    h('div', { className: 'form-group' },
      h('label', { className: 'form-label', textContent: 'Port' }),
      portInput,
      h('div', { className: 'form-hint', textContent: 'Leave empty for auto-assignment (18801-18999).' })
    ),
    h('div', { className: 'form-group' },
      h('label', { className: 'form-label', textContent: 'Model Provider' }),
      providerInput
    ),
    h('div', { className: 'form-group' },
      h('label', { className: 'form-label', textContent: 'Model Name' }),
      modelInput
    ),
    h('div', { className: 'modal-actions' },
      h('button', { className: 'btn', textContent: 'Cancel', onClick: closeModal }),
      h('button', { className: 'btn btn-primary', id: 'create-submit', textContent: 'Create', onClick: doCreateInstance })
    )
  );
  showModal(modal);
  nameInput.focus();
}

async function doCreateInstance() {
  var name = (document.getElementById('create-name') || {}).value || '';
  var portStr = (document.getElementById('create-port') || {}).value || '';
  var provider = (document.getElementById('create-provider') || {}).value || '';
  var model = (document.getElementById('create-model') || {}).value || '';
  var errorDiv = document.getElementById('create-error');
  var submitBtn = document.getElementById('create-submit');

  if (!name.trim()) {
    if (errorDiv) { clear(errorDiv); errorDiv.appendChild(h('div', { className: 'notify notify-error', textContent: 'Name is required' })); }
    return;
  }

  var body = { name: name.trim() };
  if (portStr) body.port = parseInt(portStr, 10);
  if (provider) body.model_provider = provider;
  if (model) body.model_name = model;

  if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Creating...'; }

  try {
    var res = await api('/instances', { method: 'POST', body: body });
    if (res.status === 201) {
      closeModal();
      route(); // refresh dashboard
      setTimeout(function() {
        var notify = document.getElementById('dashboard-notify');
        if (notify) showNotify(notify, 'success', 'Instance "' + name + '" created on port ' + (res.data && res.data.port));
      }, 100);
    } else {
      if (errorDiv) { clear(errorDiv); errorDiv.appendChild(h('div', { className: 'notify notify-error', textContent: apiErrorMsg(res) })); }
      if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Create'; }
    }
  } catch (e) {
    if (e.name === 'AbortError') return;
    if (errorDiv) { clear(errorDiv); errorDiv.appendChild(h('div', { className: 'notify notify-error', textContent: 'Error: ' + e.message })); }
    if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Create'; }
  }
}

// ── Clone instance dialog ───────────────────────────────────────
function showCloneDialog(sourceName) {
  var nameInput = h('input', { className: 'form-input', type: 'text', id: 'clone-name', placeholder: sourceName + '-clone' });
  var portInput = h('input', { className: 'form-input', type: 'number', id: 'clone-port', placeholder: 'Auto-assign' });
  var errorDiv = h('div', { id: 'clone-error' });

  var modal = h('div', { className: 'modal' },
    h('h3', { textContent: 'Clone "' + sourceName + '"' }),
    h('p', { textContent: 'Creates an independent copy with a new UUID, port, and cleared auth state.', style: 'font-size:13px;color:var(--text-dim);margin-bottom:12px' }),
    errorDiv,
    h('div', { className: 'form-group' },
      h('label', { className: 'form-label', textContent: 'New Name *' }),
      nameInput
    ),
    h('div', { className: 'form-group' },
      h('label', { className: 'form-label', textContent: 'Port' }),
      portInput,
      h('div', { className: 'form-hint', textContent: 'Leave empty for auto-assignment.' })
    ),
    h('div', { className: 'modal-actions' },
      h('button', { className: 'btn', textContent: 'Cancel', onClick: closeModal }),
      h('button', { className: 'btn btn-clone', id: 'clone-submit', textContent: 'Clone', onClick: function() { doCloneInstance(sourceName); } })
    )
  );
  showModal(modal);
  nameInput.focus();
}

async function doCloneInstance(sourceName) {
  var newName = (document.getElementById('clone-name') || {}).value || '';
  var portStr = (document.getElementById('clone-port') || {}).value || '';
  var errorDiv = document.getElementById('clone-error');
  var submitBtn = document.getElementById('clone-submit');

  if (!newName.trim()) {
    if (errorDiv) { clear(errorDiv); errorDiv.appendChild(h('div', { className: 'notify notify-error', textContent: 'Name is required' })); }
    return;
  }

  var body = { new_name: newName.trim() };
  if (portStr) body.port = parseInt(portStr, 10);

  if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Cloning...'; }

  try {
    var res = await api('/instances/' + encodeURIComponent(sourceName) + '/clone', { method: 'POST', body: body });
    if (res.status === 201) {
      closeModal();
      location.hash = '#/instance/' + encodeURIComponent(newName.trim());
    } else {
      if (errorDiv) { clear(errorDiv); errorDiv.appendChild(h('div', { className: 'notify notify-error', textContent: apiErrorMsg(res) })); }
      if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Clone'; }
    }
  } catch (e) {
    if (e.name === 'AbortError') return;
    if (errorDiv) { clear(errorDiv); errorDiv.appendChild(h('div', { className: 'notify notify-error', textContent: 'Error: ' + e.message })); }
    if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Clone'; }
  }
}

// ── Archive / Unarchive / Delete actions ────────────────────────
async function doArchiveInstance(name) {
  confirmDialog(
    'Archive "' + name + '"?',
    'This will stop the instance if running and remove it from the active list. You can unarchive it later.',
    'Archive',
    'btn-archive',
    async function() {
      try {
        var res = await api('/instances/' + encodeURIComponent(name) + '/archive', { method: 'POST' });
        if (res.status === 200) {
          location.hash = '#/';
          setTimeout(function() {
            var notify = document.getElementById('dashboard-notify');
            if (notify) showNotify(notify, 'success', '"' + name + '" archived');
          }, 100);
        } else {
          var content = document.getElementById('tab-content');
          if (content) showNotify(content, 'error', apiErrorMsg(res));
        }
      } catch (e) {
        if (e.name === 'AbortError') return;
        var content = document.getElementById('tab-content');
        if (content) showNotify(content, 'error', 'Archive failed: ' + e.message);
      }
    }
  );
}

async function doUnarchiveInstance(name) {
  try {
    var res = await api('/instances/' + encodeURIComponent(name) + '/unarchive', { method: 'POST' });
    if (res.status === 200) {
      location.hash = '#/instance/' + encodeURIComponent(name);
    } else {
      var content = document.getElementById('tab-content');
      if (content) showNotify(content, 'error', apiErrorMsg(res));
    }
  } catch (e) {
    if (e.name === 'AbortError') return;
    var content = document.getElementById('tab-content');
    if (content) showNotify(content, 'error', 'Unarchive failed: ' + e.message);
  }
}

async function doDeleteInstance(name) {
  confirmDialog(
    'Permanently delete "' + name + '"?',
    'This will remove all config, workspace, and event data. Messages are preserved. This cannot be undone.',
    'Delete permanently',
    'btn-danger',
    async function() {
      try {
        var res = await api('/instances/' + encodeURIComponent(name), { method: 'DELETE' });
        if (res.status === 200) {
          location.hash = '#/';
          setTimeout(function() {
            var notify = document.getElementById('dashboard-notify');
            if (notify) showNotify(notify, 'success', '"' + name + '" deleted');
          }, 100);
        } else {
          var content = document.getElementById('tab-content');
          if (content) showNotify(content, 'error', apiErrorMsg(res));
        }
      } catch (e) {
        if (e.name === 'AbortError') return;
        var content = document.getElementById('tab-content');
        if (content) showNotify(content, 'error', 'Delete failed: ' + e.message);
      }
    }
  );
}

// ── Instance detail ──────────────────────────────────────────────
function renderInstance(gen) {
  const app = document.getElementById('app');
  clear(app);

  // Header
  const header = h('div', { className: 'instance-header' },
    h('div', { className: 'instance-title' },
      h('a', { className: 'back-link', href: '#/', textContent: 'Instances' }),
      h('span', { textContent: ' / ', style: 'color:var(--text-dim)' }),
      h('h2', { textContent: state.instance })
    ),
    h('div', { className: 'btn-group', id: 'action-btns' })
  );
  app.appendChild(header);

  // Tabs
  var tabs = ['overview', 'logs', 'config', 'events', 'telegram', 'flows', 'usage'];
  var tabBar = h('div', { className: 'tabs' });
  for (var i = 0; i < tabs.length; i++) {
    (function(t) {
      var btn = h('button', {
        className: 'tab' + (state.tab === t ? ' active' : ''),
        textContent: t.charAt(0).toUpperCase() + t.slice(1),
        onClick: function() { location.hash = '#/instance/' + encodeURIComponent(state.instance) + '/' + t; }
      });
      tabBar.appendChild(btn);
    })(tabs[i]);
  }
  app.appendChild(tabBar);

  // Content container
  var content = h('div', { id: 'tab-content' });
  app.appendChild(content);

  // Render selected tab
  if (state.tab === 'overview') renderOverview(gen);
  else if (state.tab === 'logs') renderLogs(gen);
  else if (state.tab === 'config') renderConfig(gen);
  else if (state.tab === 'events') renderEvents(gen);
  else if (state.tab === 'telegram') renderTelegram(gen);
  else if (state.tab === 'flows') renderFlows(gen);
  else if (state.tab === 'usage') renderUsage(gen);
}

// ── Overview tab ─────────────────────────────────────────────────
async function renderOverview(gen) {
  var content = document.getElementById('tab-content');
  clear(content);
  content.appendChild(h('div', { className: 'loading', textContent: 'Loading details...' }));

  try {
    var res = await api('/instances/' + encodeURIComponent(state.instance) + '/details');
    if (gen !== state.routeGeneration) return;
    if (res.status !== 200) {
      clear(content);
      content.appendChild(h('div', { className: 'notify notify-error', textContent: (res.data && res.data.error) || 'Failed to load details' }));
      return;
    }
    paintOverview(res.data);
  } catch (e) {
    if (e.name === 'AbortError') return;
    clear(content);
    content.appendChild(h('div', { className: 'notify notify-error', textContent: 'Error: ' + e.message }));
  }
}

function paintOverview(data) {
  var content = document.getElementById('tab-content');
  clear(content);

  var inst = data.instance || {};

  // Action buttons
  var btns = document.getElementById('action-btns');
  var isArchived = inst.status === 'archived' || state.instanceArchived;
  if (btns) {
    clear(btns);
    if (isArchived) {
      // Archived instance: unarchive + delete
      btns.appendChild(h('button', { className: 'btn btn-primary', textContent: 'Unarchive', onClick: function() { doUnarchiveInstance(inst.name); } }));
      btns.appendChild(h('button', { className: 'btn btn-danger', textContent: 'Delete', onClick: function() { doDeleteInstance(inst.name); } }));
    } else {
      // Active instance: lifecycle + archive/clone
      btns.appendChild(makeActionBtn('Start', 'btn-start', '/instances/' + encodeURIComponent(inst.name) + '/start', 'POST'));
      btns.appendChild(makeActionBtn('Stop', 'btn-stop', '/instances/' + encodeURIComponent(inst.name) + '/stop', 'POST'));
      btns.appendChild(makeActionBtn('Restart', 'btn-restart', '/instances/' + encodeURIComponent(inst.name) + '/restart', 'POST'));
      btns.appendChild(h('button', { className: 'btn btn-clone', textContent: 'Clone', onClick: function() { showCloneDialog(inst.name); } }));
      btns.appendChild(h('button', { className: 'btn btn-archive', textContent: 'Archive', onClick: function() { doArchiveInstance(inst.name); } }));
    }
  }

  // Archived banner
  if (isArchived) {
    content.appendChild(h('div', { className: 'notify notify-warn', style: 'margin-bottom:16px',
      textContent: 'This instance is archived. Unarchive it to start or modify it.' }));
  }

  // Instance info panel
  var detailGrid = h('div', { className: 'detail-grid' },
    h('span', { className: 'detail-label', textContent: 'Name' }),
    h('span', { className: 'detail-value', textContent: inst.name || '-' }),
    h('span', { className: 'detail-label', textContent: 'ID' }),
    h('span', { className: 'detail-value', textContent: inst.id || '-' }),
    h('span', { className: 'detail-label', textContent: 'Port' }),
    h('span', { className: 'detail-value', textContent: String(inst.port || '-') }),
    h('span', { className: 'detail-label', textContent: 'PID' }),
    h('span', { className: 'detail-value', textContent: inst.pid ? String(inst.pid) : 'None' }),
    h('span', { className: 'detail-label', textContent: 'Status' }),
    h('span', { className: 'detail-value', textContent: inst.status || 'unknown' })
  );
  if (inst.archived_at) {
    detailGrid.appendChild(h('span', { className: 'detail-label', textContent: 'Archived' }));
    detailGrid.appendChild(h('span', { className: 'detail-value', textContent: inst.archived_at }));
  }
  var panel = h('div', { className: 'panel' },
    h('div', { className: 'panel-header' },
      h('span', { className: 'panel-title', textContent: 'Instance Details' }),
      h('span', { className: 'status ' + statusClass(inst.status), textContent: inst.status || 'unknown' })
    ),
    detailGrid
  );
  content.appendChild(panel);

  // Model info
  if (data.model) {
    var modelPanel = h('div', { className: 'panel', style: 'margin-top:16px' },
      h('div', { className: 'panel-title', textContent: 'Model Configuration', style: 'margin-bottom:12px' }),
      h('div', { className: 'detail-grid' },
        h('span', { className: 'detail-label', textContent: 'Provider' }),
        h('span', { className: 'detail-value', textContent: data.model.provider || 'unknown' }),
        h('span', { className: 'detail-label', textContent: 'Model' }),
        h('span', { className: 'detail-value', textContent: data.model.model || 'unknown' }),
        h('span', { className: 'detail-label', textContent: 'Routes' }),
        h('span', { className: 'detail-value', textContent: String(data.model.routes_count || 0) })
      )
    );
    content.appendChild(modelPanel);
  }

  // Runtime info
  if (data.runtime) {
    var runtimePanel = h('div', { className: 'panel', style: 'margin-top:16px' },
      h('div', { className: 'panel-title', textContent: 'Runtime', style: 'margin-bottom:12px' }),
      h('div', { className: 'detail-grid' },
        h('span', { className: 'detail-label', textContent: 'Kind' }),
        h('span', { className: 'detail-value', textContent: data.runtime.kind || 'unknown' }),
        h('span', { className: 'detail-label', textContent: 'Docker Image' }),
        h('span', { className: 'detail-value', textContent: data.runtime.docker_image || 'None' })
      )
    );
    content.appendChild(runtimePanel);
  }

  // Channels
  if (data.channels) {
    var chPanel = h('div', { className: 'panel', style: 'margin-top:16px' },
      h('div', { className: 'panel-title', textContent: 'Channels', style: 'margin-bottom:12px' })
    );
    var chGrid = h('div', { className: 'detail-grid' });
    for (var key of Object.keys(data.channels)) {
      var val = data.channels[key];
      var display = typeof val === 'boolean' ? (val ? 'Enabled' : 'Disabled') : (val && val.configured ? 'Configured' : String(val));
      chGrid.appendChild(h('span', { className: 'detail-label', textContent: key }));
      chGrid.appendChild(h('span', { className: 'detail-value', textContent: display }));
    }
    chPanel.appendChild(chGrid);
    content.appendChild(chPanel);
  }
}

function makeActionBtn(label, cls, path, method) {
  var btn = h('button', { className: 'btn ' + cls, textContent: label });
  btn.addEventListener('click', async function() {
    btn.disabled = true;
    btn.textContent = label + '...';
    try {
      var res = await api(path, { method: method });
      if (res.status === 200) {
        btn.textContent = label;
        btn.disabled = false;
        route(); // refresh
      } else {
        btn.textContent = label;
        btn.disabled = false;
        var msg = (res.data && res.data.error) || 'Action failed';
        var content = document.getElementById('tab-content');
        if (content) showNotify(content, 'error', msg);
      }
    } catch (e) {
      if (e.name === 'AbortError') return;
      btn.textContent = label;
      btn.disabled = false;
      var content = document.getElementById('tab-content');
      if (content) showNotify(content, 'error', label + ' failed: ' + e.message);
    }
  });
  return btn;
}

// ── Logs tab ─────────────────────────────────────────────────────
async function renderLogs(gen) {
  var content = document.getElementById('tab-content');
  clear(content);

  var panel = h('div', { className: 'panel' });
  var header = h('div', { className: 'panel-header' },
    h('span', { className: 'panel-title', textContent: 'Logs (last 100 lines)' }),
    h('div', { className: 'btn-group' },
      h('a', {
        className: 'btn',
        href: '/api/instances/' + encodeURIComponent(state.instance) + '/logs/download',
        target: '_blank',
        textContent: 'Download'
      })
    )
  );
  panel.appendChild(header);

  var viewer = h('pre', { className: 'log-viewer', id: 'log-viewer', textContent: 'Loading logs...' });
  panel.appendChild(viewer);
  content.appendChild(panel);

  async function fetchLogs() {
    try {
      var res = await api('/instances/' + encodeURIComponent(state.instance) + '/logs?lines=100&mode=tail');
      if (gen !== state.routeGeneration) return;
      var lv = document.getElementById('log-viewer');
      if (!lv) return;
      if (res.status !== 200) {
        var errMsg = (res.data && res.data.error) || ('Failed to fetch logs (HTTP ' + res.status + ')');
        lv.textContent = 'Error: ' + errMsg;
        return;
      }
      var lines = (res.data && res.data.lines) || [];
      if (lines.length === 0) {
        lv.textContent = 'No log output yet.';
      } else {
        var wasAtBottom = lv.scrollHeight - lv.scrollTop - lv.clientHeight < 50;
        lv.textContent = lines.join('\n');
        if (wasAtBottom) lv.scrollTop = lv.scrollHeight;
      }
    } catch (e) {
      if (e.name === 'AbortError') return;
      var lv2 = document.getElementById('log-viewer');
      if (lv2) lv2.textContent = 'Error: ' + e.message;
    }
  }

  await fetchLogs();
  state.refreshTimer = setInterval(fetchLogs, 3000);
}

// ── Config tab ───────────────────────────────────────────────────
async function renderConfig(gen) {
  var content = document.getElementById('tab-content');
  clear(content);
  content.appendChild(h('div', { className: 'loading', textContent: 'Loading config...' }));

  try {
    var res = await api('/instances/' + encodeURIComponent(state.instance) + '/config');
    if (gen !== state.routeGeneration) return;
    if (res.status !== 200) {
      clear(content);
      content.appendChild(h('div', { className: 'notify notify-error', textContent: (res.data && res.data.error) || 'Failed to load config' }));
      return;
    }
    state.configEtag = res.data.etag;
    paintConfig(res.data);
  } catch (e) {
    if (e.name === 'AbortError') return;
    clear(content);
    content.appendChild(h('div', { className: 'notify notify-error', textContent: 'Error: ' + e.message }));
  }
}

function paintConfig(data) {
  var content = document.getElementById('tab-content');
  clear(content);

  var notifyArea = h('div', { id: 'config-notify' });
  content.appendChild(notifyArea);

  var panel = h('div', { className: 'panel' });
  var header = h('div', { className: 'panel-header' },
    h('span', { className: 'panel-title', textContent: 'Configuration (TOML)' }),
    h('div', { className: 'btn-group' },
      h('button', { className: 'btn', id: 'btn-validate', textContent: 'Validate' }),
      h('button', { className: 'btn', id: 'btn-diff', textContent: 'Diff' }),
      h('button', { className: 'btn btn-primary', id: 'btn-save', textContent: 'Save' })
    )
  );
  panel.appendChild(header);

  var editor = h('textarea', { className: 'config-editor', id: 'config-editor' });
  editor.value = data.config_toml || '';
  panel.appendChild(editor);

  var diffArea = h('div', { id: 'diff-area' });
  panel.appendChild(diffArea);

  var conflictArea = h('div', { id: 'conflict-area' });
  panel.appendChild(conflictArea);

  content.appendChild(panel);

  // Wire up buttons
  document.getElementById('btn-validate').addEventListener('click', doValidate);
  document.getElementById('btn-diff').addEventListener('click', doDiff);
  document.getElementById('btn-save').addEventListener('click', doSave);
}

async function doValidate() {
  var notify = document.getElementById('config-notify');
  var editor = document.getElementById('config-editor');
  if (!editor) return;
  try {
    var res = await api('/instances/' + encodeURIComponent(state.instance) + '/config/validate', {
      method: 'POST',
      body: { config: editor.value }
    });
    if (res.data && res.data.valid) {
      showNotify(notify, 'success', 'Config is valid');
    } else {
      showNotify(notify, 'error', 'Invalid: ' + ((res.data && res.data.error) || 'Unknown error'));
    }
  } catch (e) {
    if (e.name === 'AbortError') return;
    showNotify(notify, 'error', 'Validation failed: ' + e.message);
  }
}

async function doDiff() {
  var editor = document.getElementById('config-editor');
  var diffArea = document.getElementById('diff-area');
  if (!editor || !diffArea) return;
  clear(diffArea);
  try {
    var res = await api('/instances/' + encodeURIComponent(state.instance) + '/config/diff', {
      method: 'POST',
      body: { config: editor.value }
    });
    if (res.status !== 200) {
      var notify = document.getElementById('config-notify');
      showNotify(notify, 'error', (res.data && res.data.error) || 'Diff failed');
      return;
    }
    var d = res.data;
    var panel = h('div', { className: 'diff-panel' });
    if (d.changes && d.changes.length > 0) {
      panel.appendChild(h('div', { className: 'diff-change', style: 'margin-bottom:8px;font-weight:600', textContent: 'Changes:' }));
      for (var c of d.changes) {
        var line = h('div', { className: 'diff-change' });
        line.textContent = '  ' + c.path + ': ' + JSON.stringify(c.from) + ' -> ' + JSON.stringify(c.to);
        panel.appendChild(line);
      }
    }
    if (d.added && d.added.length > 0) {
      panel.appendChild(h('div', { className: 'diff-add', style: 'margin-top:8px;font-weight:600', textContent: 'Added:' }));
      for (var a of d.added) {
        var aLine = h('div', { className: 'diff-add' });
        aLine.textContent = '  + ' + a.path + ': ' + JSON.stringify(a.value);
        panel.appendChild(aLine);
      }
    }
    if (d.removed && d.removed.length > 0) {
      panel.appendChild(h('div', { className: 'diff-remove', style: 'margin-top:8px;font-weight:600', textContent: 'Removed:' }));
      for (var r of d.removed) {
        var rLine = h('div', { className: 'diff-remove' });
        rLine.textContent = '  - ' + r.path + ': ' + JSON.stringify(r.value);
        panel.appendChild(rLine);
      }
    }
    if ((!d.changes || d.changes.length === 0) && (!d.added || d.added.length === 0) && (!d.removed || d.removed.length === 0)) {
      panel.appendChild(h('div', { textContent: 'No changes detected.', style: 'color:var(--text-dim)' }));
    }
    if (d.unchanged_count != null) {
      panel.appendChild(h('div', { style: 'margin-top:8px;color:var(--text-dim);font-size:12px', textContent: d.unchanged_count + ' fields unchanged' }));
    }
    diffArea.appendChild(panel);
  } catch (e) {
    if (e.name === 'AbortError') return;
  }
}

async function doSave() {
  var editor = document.getElementById('config-editor');
  var notify = document.getElementById('config-notify');
  var conflictArea = document.getElementById('conflict-area');
  if (!editor) return;

  var btn = document.getElementById('btn-save');
  if (btn) { btn.disabled = true; btn.textContent = 'Saving...'; }

  try {
    var res = await api('/instances/' + encodeURIComponent(state.instance) + '/config', {
      method: 'PUT',
      body: { config: editor.value, etag: state.configEtag }
    });

    if (btn) { btn.disabled = false; btn.textContent = 'Save'; }

    if (res.status === 200) {
      state.configEtag = res.data.etag;
      showNotify(notify, 'success', 'Config saved successfully');
      if (conflictArea) clear(conflictArea);
      if (res.data.restart_recommended) {
        showNotify(notify, 'warn', 'Instance is running - restart recommended for changes to take effect');
      }
    } else if (res.status === 409) {
      // Conflict
      if (conflictArea) {
        clear(conflictArea);
        var dialog = h('div', { className: 'conflict-dialog' },
          h('h3', { textContent: 'Conflict Detected' }),
          h('p', { textContent: 'Config was modified elsewhere since you loaded it. Your local changes have NOT been saved.' }),
          h('p', { textContent: 'You may want to copy your changes before reloading.', style: 'font-style:italic' }),
          h('button', { className: 'btn btn-primary', textContent: 'Reload Config', onClick: function() {
            renderConfig(state.routeGeneration);
          }})
        );
        conflictArea.appendChild(dialog);
      }
    } else if (res.status === 400) {
      var msg = (res.data && res.data.error) || 'Invalid config';
      showNotify(notify, 'error', msg);
      if (res.data && res.data.blocked_fields) {
        showNotify(notify, 'error', msg + ' - Blocked fields: ' + res.data.blocked_fields.join(', '));
      }
    } else {
      showNotify(notify, 'error', (res.data && res.data.error) || 'Save failed');
    }
  } catch (e) {
    if (e.name === 'AbortError') return;
    if (btn) { btn.disabled = false; btn.textContent = 'Save'; }
    showNotify(notify, 'error', 'Save error: ' + e.message);
  }
}

// ── Events tab ───────────────────────────────────────────────────
async function renderEvents(gen) {
  var content = document.getElementById('tab-content');
  clear(content);
  content.appendChild(h('div', { className: 'loading', textContent: 'Loading events...' }));

  var offset = 0;
  var limit = 20;

  async function load() {
    try {
      var res = await api('/instances/' + encodeURIComponent(state.instance) + '/tasks?limit=' + limit + '&offset=' + offset);
      if (gen !== state.routeGeneration) return;
      if (res.status !== 200) {
        clear(content);
        content.appendChild(h('div', { className: 'notify notify-error', textContent: (res.data && res.data.error) || 'Failed to load events' }));
        return;
      }
      paintEvents(res.data, gen);
    } catch (e) {
      if (e.name === 'AbortError') return;
      clear(content);
      content.appendChild(h('div', { className: 'notify notify-error', textContent: 'Error: ' + e.message }));
    }
  }

  function paintEvents(data) {
    clear(content);
    var panel = h('div', { className: 'panel' });
    panel.appendChild(h('div', { className: 'panel-title', textContent: 'Events', style: 'margin-bottom:12px' }));

    var tasks = data.tasks || [];
    if (tasks.length === 0) {
      panel.appendChild(h('div', { className: 'empty-state', textContent: data.message || 'No events recorded yet.' }));
      content.appendChild(panel);
      return;
    }

    var table = h('table', { className: 'data-table' });
    var thead = h('thead', null,
      h('tr', null,
        h('th', { textContent: 'Time' }),
        h('th', { textContent: 'Type' }),
        h('th', { textContent: 'Channel' }),
        h('th', { textContent: 'Summary' }),
        h('th', { textContent: 'Status' }),
        h('th', { textContent: 'Duration' })
      )
    );
    table.appendChild(thead);

    var tbody = h('tbody');
    for (var t of tasks) {
      var row = h('tr', null,
        h('td', { textContent: fmtTime(t.created_at) }),
        h('td', { textContent: t.event_type || '-' }),
        h('td', { textContent: t.channel || '-' }),
        h('td', { textContent: t.summary || '-' }),
        h('td', null, h('span', { className: 'status ' + statusClass(t.status === 'completed' ? 'running' : t.status === 'failed' ? 'dead' : 'unknown'), textContent: t.status || '-' })),
        h('td', { textContent: fmtDuration(t.duration_ms) })
      );
      tbody.appendChild(row);
    }
    table.appendChild(tbody);
    panel.appendChild(table);

    // Pagination
    var total = data.total || 0;
    var pag = h('div', { className: 'pagination' },
      h('span', { textContent: 'Showing ' + (offset + 1) + '-' + (offset + tasks.length) + ' of ' + total })
    );
    if (offset > 0) {
      pag.appendChild(h('button', { className: 'btn', textContent: 'Previous', onClick: function() { offset = Math.max(0, offset - limit); load(); } }));
    }
    if (offset + limit < total) {
      pag.appendChild(h('button', { className: 'btn', textContent: 'Next', onClick: function() { offset += limit; load(); } }));
    }
    panel.appendChild(pag);
    content.appendChild(panel);
  }

  await load();
}

// ── Telegram tab ─────────────────────────────────────────────────
async function renderTelegram(gen) {
  var content = document.getElementById('tab-content');
  clear(content);

  // Health section
  var healthPanel = h('div', { className: 'panel', style: 'margin-bottom:20px' });
  var healthHeader = h('div', { className: 'panel-header' },
    h('div', { className: 'panel-title', textContent: 'Telegram Health' })
  );
  healthPanel.appendChild(healthHeader);

  var currentHealthWindow = '5m';

  function buildWindowSelector(parent) {
    var existing = parent.querySelector('.window-select');
    if (existing) existing.remove();
    var selector = h('div', { className: 'window-select', style: 'margin-bottom:12px' });
    var windows = ['1m', '5m', '15m', '1h'];
    for (var i = 0; i < windows.length; i++) {
      (function(w) {
        selector.appendChild(h('button', {
          className: 'window-btn' + (w === currentHealthWindow ? ' active' : ''),
          textContent: w,
          onClick: function() { currentHealthWindow = w; loadHealth(); }
        }));
      })(windows[i]);
    }
    parent.insertBefore(selector, healthHeader.nextSibling);
  }

  var healthGrid = h('div', { className: 'usage-grid', id: 'tg-health-grid' });
  healthPanel.appendChild(healthGrid);
  content.appendChild(healthPanel);

  async function loadHealth() {
    buildWindowSelector(healthPanel);
    var grid = document.getElementById('tg-health-grid');
    if (!grid) return;
    clear(grid);
    grid.appendChild(h('div', { className: 'loading', textContent: 'Loading health...' }));
    try {
      var res = await api('/instances/' + encodeURIComponent(state.instance) + '/telegram/health?window=' + currentHealthWindow);
      if (gen !== state.routeGeneration) return;
      if (res.status !== 200) {
        clear(grid);
        grid.appendChild(h('div', { className: 'notify notify-error', textContent: apiErrorMsg(res) }));
        return;
      }
      paintHealth(res.data, grid);
    } catch (e) {
      if (e.name === 'AbortError') return;
      clear(grid);
      grid.appendChild(h('div', { className: 'notify notify-error', textContent: 'Error: ' + e.message }));
    }
  }

  function paintHealth(data, grid) {
    clear(grid);
    var c = data.counters || {};
    var stats = [
      { label: 'Events/min', value: c.events_per_min != null ? c.events_per_min.toFixed(1) : '0' },
      { label: 'Inbound', value: fmtNum(c.inbound_count) },
      { label: 'Outbound', value: fmtNum(c.outbound_count) },
      { label: 'Auth Rejects', value: fmtNum(c.auth_reject_count) },
      { label: 'Guard Rejects', value: fmtNum(c.guard_reject_count) },
      { label: 'Callback Reject %', value: c.callback_reject_rate != null ? c.callback_reject_rate.toFixed(1) + '%' : '-' },
      { label: 'STT Error %', value: c.stt_error_rate != null ? c.stt_error_rate.toFixed(1) + '%' : '-' },
      { label: 'STT P95 Latency', value: fmtDuration(c.stt_p95_latency_ms) },
    ];
    for (var s of stats) {
      grid.appendChild(h('div', { className: 'usage-stat' },
        h('div', { className: 'usage-stat-label', textContent: s.label }),
        h('div', { className: 'usage-stat-value', textContent: s.value })
      ));
    }
  }

  // Health auto-refresh: 15s
  await loadHealth();
  state.refreshTimer = setInterval(function() {
    if (gen !== state.routeGeneration) return;
    loadHealth();
  }, 15000);

  // Events section
  var eventsPanel = h('div', { className: 'panel' });
  var eventsHeader = h('div', { className: 'panel-header' },
    h('div', { className: 'panel-title', textContent: 'Telegram Events' }),
    h('button', { className: 'btn', textContent: 'Refresh', onClick: function() { loadTelegramEvents(); } })
  );
  eventsPanel.appendChild(eventsHeader);

  // Filter bar
  var filterEventType = '';
  var filterStatus = '';
  var filterChatId = '';
  var filterAfter = '';
  var filterBefore = '';
  var evtOffset = 0;
  var evtLimit = 20;

  function buildEventsFilter() {
    var bar = h('div', { className: 'filter-bar' });
    var fType = h('div', { className: 'filter-field' },
      h('label', { textContent: 'Event Type' }),
      h('input', { type: 'text', value: filterEventType, placeholder: 'e.g. tg.inbound.message', onInput: function(e) { filterEventType = e.target.value; } })
    );
    var fStatus = h('div', { className: 'filter-field' },
      h('label', { textContent: 'Status' }),
      h('input', { type: 'text', value: filterStatus, placeholder: 'e.g. completed', onInput: function(e) { filterStatus = e.target.value; } })
    );
    var fChat = h('div', { className: 'filter-field' },
      h('label', { textContent: 'Chat ID' }),
      h('input', { type: 'text', value: filterChatId, placeholder: 'Chat ID', onInput: function(e) { filterChatId = e.target.value; } })
    );
    var fAfter = h('div', { className: 'filter-field' },
      h('label', { textContent: 'After' }),
      h('input', { type: 'datetime-local', value: filterAfter, onInput: function(e) { filterAfter = e.target.value; } })
    );
    var fBefore = h('div', { className: 'filter-field' },
      h('label', { textContent: 'Before' }),
      h('input', { type: 'datetime-local', value: filterBefore, onInput: function(e) { filterBefore = e.target.value; } })
    );
    bar.appendChild(fType);
    bar.appendChild(fStatus);
    bar.appendChild(fChat);
    bar.appendChild(fAfter);
    bar.appendChild(fBefore);
    bar.appendChild(h('button', { className: 'btn btn-primary', textContent: 'Apply', onClick: function() { evtOffset = 0; loadTelegramEvents(); } }));
    bar.appendChild(h('button', { className: 'btn', textContent: 'Clear', onClick: function() {
      filterEventType = ''; filterStatus = ''; filterChatId = ''; filterAfter = ''; filterBefore = '';
      evtOffset = 0; loadTelegramEvents();
    }}));
    return bar;
  }

  eventsPanel.appendChild(buildEventsFilter());
  var eventsBody = h('div', { id: 'tg-events-body' });
  eventsPanel.appendChild(eventsBody);
  content.appendChild(eventsPanel);

  async function loadTelegramEvents() {
    var body = document.getElementById('tg-events-body');
    if (!body) return;
    clear(body);
    body.appendChild(h('div', { className: 'loading', textContent: 'Loading events...' }));
    state.expandedEventId = null;

    var params = 'limit=' + evtLimit + '&offset=' + evtOffset;
    if (filterEventType) params += '&event_type=' + encodeURIComponent(filterEventType);
    if (filterStatus) params += '&status=' + encodeURIComponent(filterStatus);
    if (filterChatId) params += '&chat_id=' + encodeURIComponent(filterChatId);
    if (filterAfter) params += '&after=' + encodeURIComponent(filterAfter);
    if (filterBefore) params += '&before=' + encodeURIComponent(filterBefore);

    try {
      var res = await api('/instances/' + encodeURIComponent(state.instance) + '/telegram/events?' + params);
      if (gen !== state.routeGeneration) return;
      if (res.status !== 200) {
        clear(body);
        body.appendChild(h('div', { className: 'notify notify-error', textContent: apiErrorMsg(res) }));
        return;
      }
      paintTelegramEvents(res.data, body);
    } catch (e) {
      if (e.name === 'AbortError') return;
      clear(body);
      body.appendChild(h('div', { className: 'notify notify-error', textContent: 'Error: ' + e.message }));
    }
  }

  function deriveDirection(eventType) {
    if (!eventType) return '-';
    if (eventType.indexOf('tg.inbound') === 0) return 'In';
    if (eventType.indexOf('tg.outbound') === 0) return 'Out';
    return '-';
  }

  function truncate(s, len) {
    if (!s) return '-';
    if (s.length <= len) return s;
    return s.substring(0, len) + '...';
  }

  function paintTelegramEvents(data, body) {
    clear(body);
    var events = data.events || [];
    if (events.length === 0) {
      body.appendChild(h('div', { className: 'empty-state', textContent: 'No telegram events found.' }));
      return;
    }

    var table = h('table', { className: 'data-table' });
    var thead = h('thead', null,
      h('tr', null,
        h('th', { textContent: 'Time' }),
        h('th', { textContent: 'Type' }),
        h('th', { textContent: 'Direction' }),
        h('th', { textContent: 'Chat ID' }),
        h('th', { textContent: 'Status' }),
        h('th', { textContent: 'Duration' }),
        h('th', { textContent: 'Corr. ID' })
      )
    );
    table.appendChild(thead);

    var tbody = h('tbody');
    for (var i = 0; i < events.length; i++) {
      (function(evt) {
        var chatDisplay = truncate(evt.channel || evt.chat_id || '', 12);
        var chatFull = evt.channel || evt.chat_id || '-';
        var row = h('tr', { className: 'clickable' },
          h('td', { textContent: fmtTime(evt.created_at) }),
          h('td', { textContent: evt.event_type || '-' }),
          h('td', { textContent: deriveDirection(evt.event_type) }),
          h('td', { textContent: chatDisplay, title: chatFull }),
          h('td', null, h('span', { className: 'status ' + statusClass(evt.status || 'unknown'), textContent: evt.status || '-' })),
          h('td', { textContent: fmtDuration(evt.duration_ms) }),
          h('td', { textContent: truncate(evt.correlation_id, 12), title: evt.correlation_id || '' })
        );
        row.addEventListener('click', function() {
          expandTelegramEvent(evt.id, row, gen);
        });
        tbody.appendChild(row);
      })(events[i]);
    }
    table.appendChild(tbody);
    body.appendChild(table);

    // Pagination
    var total = data.total || 0;
    if (total > 0) {
      var pag = h('div', { className: 'pagination' },
        h('span', { textContent: 'Showing ' + (evtOffset + 1) + '-' + Math.min(evtOffset + events.length, total) + ' of ' + total })
      );
      if (evtOffset > 0) {
        pag.appendChild(h('button', { className: 'btn', textContent: 'Previous', onClick: function() { evtOffset = Math.max(0, evtOffset - evtLimit); loadTelegramEvents(); } }));
      }
      if (evtOffset + evtLimit < total) {
        pag.appendChild(h('button', { className: 'btn', textContent: 'Next', onClick: function() { evtOffset += evtLimit; loadTelegramEvents(); } }));
      }
      body.appendChild(pag);
    }
  }

  async function expandTelegramEvent(eventId, row, gen) {
    // Collapse if already expanded
    if (state.expandedEventId === eventId) {
      var existing = row.nextElementSibling;
      if (existing && existing.classList.contains('event-detail-row')) existing.remove();
      state.expandedEventId = null;
      return;
    }
    // Collapse any previous expansion
    var prev = row.parentNode.querySelector('.event-detail-row');
    if (prev) prev.remove();
    state.expandedEventId = eventId;

    // Create placeholder row
    var detailRow = h('tr', { className: 'event-detail-row' });
    var detailTd = h('td', { colSpan: '7' });
    var detailContent = h('div', { className: 'event-detail-content' });
    detailContent.appendChild(h('div', { className: 'loading', textContent: 'Loading event detail...' }));
    detailTd.appendChild(detailContent);
    detailRow.appendChild(detailTd);
    row.parentNode.insertBefore(detailRow, row.nextSibling);

    try {
      var res = await api('/instances/' + encodeURIComponent(state.instance) + '/telegram/events/' + encodeURIComponent(eventId));
      if (gen !== state.routeGeneration) return;
      if (state.expandedEventId !== eventId) return;
      if (res.status !== 200) {
        clear(detailContent);
        detailContent.appendChild(h('div', { className: 'notify notify-error', textContent: apiErrorMsg(res) }));
        return;
      }
      paintEventDetail(res.data, detailContent);
    } catch (e) {
      if (e.name === 'AbortError') return;
      clear(detailContent);
      detailContent.appendChild(h('div', { className: 'notify notify-error', textContent: 'Error: ' + e.message }));
    }
  }

  function paintEventDetail(data, container) {
    clear(container);
    var header = h('div', { className: 'event-detail-header' },
      h('span', { style: 'font-weight:600;font-size:13px', textContent: 'Event Detail' }),
      h('button', { className: 'btn', textContent: 'Close', style: 'padding:2px 10px;font-size:11px', onClick: function() {
        state.expandedEventId = null;
        var dr = container.closest('.event-detail-row');
        if (dr) dr.remove();
      }})
    );
    container.appendChild(header);

    var grid = h('div', { className: 'detail-grid' });
    var fields = [
      ['Event ID', data.id || '-'],
      ['Type', data.event_type || '-'],
      ['Status', data.status || '-'],
      ['Direction', deriveDirection(data.event_type)],
      ['Duration', fmtDuration(data.duration_ms)],
      ['Chat ID', data.channel || '-'],
      ['Correlation ID', data.correlation_id || '-'],
      ['Time', fmtTime(data.created_at)],
    ];
    for (var f of fields) {
      grid.appendChild(h('div', { className: 'detail-label', textContent: f[0] }));
      if (f[0] === 'Status') {
        grid.appendChild(h('div', { className: 'detail-value' },
          h('span', { className: 'status ' + statusClass(data.status || 'unknown'), textContent: data.status || '-' })
        ));
      } else {
        grid.appendChild(h('div', { className: 'detail-value', textContent: f[1] }));
      }
    }
    container.appendChild(grid);

    if (data.metadata) {
      container.appendChild(h('div', { style: 'margin-top:12px;font-size:12px;color:var(--text-dim);font-weight:600', textContent: 'Metadata' }));
      var pre = h('pre', {
        style: 'background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius);padding:10px;font-size:12px;overflow-x:auto;margin-top:4px',
        textContent: typeof data.metadata === 'string' ? data.metadata : JSON.stringify(data.metadata, null, 2)
      });
      container.appendChild(pre);
    }
  }

  await loadTelegramEvents();
}

// ── Flows tab ────────────────────────────────────────────────────
async function renderFlows(gen) {
  var content = document.getElementById('tab-content');
  clear(content);

  // Subtab toggle
  var subtabBar = h('div', { className: 'subtab-bar' });
  function buildSubtabs() {
    clear(subtabBar);
    subtabBar.appendChild(h('button', {
      className: 'subtab' + (state.flowSubTab === 'active' ? ' active' : ''),
      textContent: 'Active',
      onClick: function() { state.flowSubTab = 'active'; renderFlows(gen); }
    }));
    subtabBar.appendChild(h('button', {
      className: 'subtab' + (state.flowSubTab === 'history' ? ' active' : ''),
      textContent: 'History',
      onClick: function() { state.flowSubTab = 'history'; renderFlows(gen); }
    }));
  }
  buildSubtabs();
  content.appendChild(subtabBar);

  var body = h('div', { id: 'flows-body' });
  content.appendChild(body);

  if (state.flowSubTab === 'active') {
    await renderActiveFlows(gen, body);
  } else {
    await renderFlowHistory(gen, body);
  }
}

async function renderActiveFlows(gen, container) {
  clear(container);
  container.appendChild(h('div', { className: 'loading', textContent: 'Loading active flows...' }));

  async function loadActive() {
    try {
      var res = await api('/instances/' + encodeURIComponent(state.instance) + '/flows/active');
      if (gen !== state.routeGeneration) return;
      if (res.status !== 200) {
        clear(container);
        container.appendChild(h('div', { className: 'notify notify-error', textContent: apiErrorMsg(res) }));
        return;
      }
      paintActiveFlows(res.data);
    } catch (e) {
      if (e.name === 'AbortError') return;
      clear(container);
      container.appendChild(h('div', { className: 'notify notify-error', textContent: 'Error: ' + e.message }));
    }
  }

  function paintActiveFlows(data) {
    clear(container);
    var panel = h('div', { className: 'panel' });
    panel.appendChild(h('div', { className: 'panel-title', textContent: 'Active Flows', style: 'margin-bottom:12px' }));

    var flows = data.flows || [];
    if (flows.length === 0) {
      panel.appendChild(h('div', { className: 'empty-state', textContent: 'No active flows.' }));
      container.appendChild(panel);
      return;
    }

    var table = h('table', { className: 'data-table' });
    var thead = h('thead', null,
      h('tr', null,
        h('th', { textContent: 'Chat ID' }),
        h('th', { textContent: 'Flow Name' }),
        h('th', { textContent: 'Current Step' }),
        h('th', { textContent: 'Started' }),
        h('th', { textContent: 'In Step Since' }),
        h('th', { textContent: 'Actions' })
      )
    );
    table.appendChild(thead);

    var tbody = h('tbody');
    for (var i = 0; i < flows.length; i++) {
      (function(flow) {
        var row = h('tr', null,
          h('td', { textContent: flow.chat_id || '-' }),
          h('td', { textContent: flow.flow_name || '-' }),
          h('td', { textContent: flow.current_step || '-' }),
          h('td', { textContent: fmtTime(flow.started_at) }),
          h('td', { textContent: fmtTime(flow.step_entered_at) }),
          h('td', null,
            h('button', {
              className: 'btn btn-danger', textContent: 'Force Complete',
              style: 'padding:3px 10px;font-size:11px;margin-right:4px',
              onClick: function(e) {
                e.stopPropagation();
                doForceComplete(flow.chat_id, flow.flow_name, gen);
              }
            }),
            h('button', {
              className: 'btn btn-primary', textContent: 'Replay...',
              style: 'padding:3px 10px;font-size:11px',
              onClick: function(e) {
                e.stopPropagation();
                showReplayModal(flow.chat_id, flow.flow_name, flow.current_step, gen);
              }
            })
          )
        );
        tbody.appendChild(row);
      })(flows[i]);
    }
    table.appendChild(tbody);
    panel.appendChild(table);
    container.appendChild(panel);
  }

  function doForceComplete(chatId, flowName, gen) {
    confirmDialog(
      'Force Complete Flow?',
      'This will force-complete the flow "' + flowName + '" for chat ' + chatId + '. This cannot be undone.',
      'Force Complete',
      'btn-danger',
      async function() {
        try {
          var res = await api('/instances/' + encodeURIComponent(state.instance) + '/flows/active/' + encodeURIComponent(chatId), { method: 'DELETE' });
          if (gen !== state.routeGeneration) return;
          if (res.status === 200) {
            showNotify(container, 'success', 'Flow force-completed for chat ' + chatId);
            loadActive();
          } else {
            showNotify(container, 'error', apiErrorMsg(res));
          }
        } catch (e) {
          showNotify(container, 'error', 'Error: ' + e.message);
        }
      }
    );
  }

  function showReplayModal(chatId, flowName, currentStep, gen) {
    var stepValue = currentStep || '';
    var modal = h('div', { className: 'modal' },
      h('h3', { textContent: 'Replay Flow' }),
      h('p', { textContent: 'Reset flow for chat ' + chatId + ' (' + flowName + ') to a specific step. Current step: ' + (currentStep || 'N/A'), style: 'font-size:13px;color:var(--text-dim);margin-bottom:12px' }),
      h('div', { className: 'form-group' },
        h('label', { className: 'form-label', textContent: 'Target Step' }),
        h('input', { className: 'form-input', type: 'text', value: stepValue, id: 'replay-step-input' }),
        h('div', { className: 'form-hint', textContent: 'The flow will resume from this step on the next interaction or timeout.' })
      ),
      h('div', { className: 'modal-actions' },
        h('button', { className: 'btn', textContent: 'Cancel', onClick: closeModal }),
        h('button', { className: 'btn btn-primary', textContent: 'Replay', onClick: async function() {
          var stepInput = document.getElementById('replay-step-input');
          var step = stepInput ? stepInput.value.trim() : '';
          if (!step) return;
          closeModal();
          await doReplay(chatId, step, gen);
        }})
      )
    );
    showModal(modal);
  }

  async function doReplay(chatId, step, gen) {
    try {
      var res = await api('/instances/' + encodeURIComponent(state.instance) + '/flows/active/' + encodeURIComponent(chatId) + '/replay', {
        method: 'POST',
        body: { step: step }
      });
      if (gen !== state.routeGeneration) return;
      if (res.status === 200) {
        showNotify(container, 'success', 'Flow replayed to step "' + step + '" for chat ' + chatId);
        loadActive();
      } else {
        showNotify(container, 'error', apiErrorMsg(res));
      }
    } catch (e) {
      showNotify(container, 'error', 'Error: ' + e.message);
    }
  }

  await loadActive();

  // Auto-refresh: 10s
  state.refreshTimer = setInterval(function() {
    if (gen !== state.routeGeneration) return;
    loadActive();
  }, 10000);
}

async function renderFlowHistory(gen, container) {
  clear(container);

  var histFilterName = '';
  var histFilterStatus = '';
  var histFilterChat = '';
  var histOffset = 0;
  var histLimit = 20;

  // Filter bar
  function buildHistoryFilter() {
    var bar = h('div', { className: 'filter-bar' });
    bar.appendChild(h('div', { className: 'filter-field' },
      h('label', { textContent: 'Flow Name' }),
      h('input', { type: 'text', value: histFilterName, placeholder: 'Flow name', onInput: function(e) { histFilterName = e.target.value; } })
    ));
    var statusSelect = h('select');
    var opts = [
      { value: '', label: 'All' },
      { value: 'completed', label: 'Completed' },
      { value: 'timed_out', label: 'Timed Out' },
      { value: 'force_completed', label: 'Force Completed' },
    ];
    for (var o of opts) {
      var opt = h('option', { value: o.value, textContent: o.label });
      if (o.value === histFilterStatus) opt.selected = true;
      statusSelect.appendChild(opt);
    }
    statusSelect.addEventListener('change', function(e) { histFilterStatus = e.target.value; });
    bar.appendChild(h('div', { className: 'filter-field' },
      h('label', { textContent: 'Status' }),
      statusSelect
    ));
    bar.appendChild(h('div', { className: 'filter-field' },
      h('label', { textContent: 'Chat ID' }),
      h('input', { type: 'text', value: histFilterChat, placeholder: 'Chat ID', onInput: function(e) { histFilterChat = e.target.value; } })
    ));
    bar.appendChild(h('button', { className: 'btn btn-primary', textContent: 'Apply', onClick: function() { histOffset = 0; loadHistory(); } }));
    bar.appendChild(h('button', { className: 'btn', textContent: 'Clear', onClick: function() {
      histFilterName = ''; histFilterStatus = ''; histFilterChat = '';
      histOffset = 0; loadHistory();
    }}));
    return bar;
  }

  container.appendChild(buildHistoryFilter());
  var histBody = h('div', { id: 'flow-history-body' });
  container.appendChild(histBody);

  async function loadHistory() {
    var body = document.getElementById('flow-history-body');
    if (!body) return;
    clear(body);
    body.appendChild(h('div', { className: 'loading', textContent: 'Loading flow history...' }));

    var params = 'limit=' + histLimit + '&offset=' + histOffset;
    if (histFilterName) params += '&flow_name=' + encodeURIComponent(histFilterName);
    if (histFilterStatus) params += '&status=' + encodeURIComponent(histFilterStatus);
    if (histFilterChat) params += '&chat_id=' + encodeURIComponent(histFilterChat);

    try {
      var res = await api('/instances/' + encodeURIComponent(state.instance) + '/flows/history?' + params);
      if (gen !== state.routeGeneration) return;
      if (res.status !== 200) {
        clear(body);
        body.appendChild(h('div', { className: 'notify notify-error', textContent: apiErrorMsg(res) }));
        return;
      }
      paintFlowHistory(res.data, body);
    } catch (e) {
      if (e.name === 'AbortError') return;
      clear(body);
      body.appendChild(h('div', { className: 'notify notify-error', textContent: 'Error: ' + e.message }));
    }
  }

  function paintFlowHistory(data, body) {
    clear(body);
    var panel = h('div', { className: 'panel' });
    panel.appendChild(h('div', { className: 'panel-title', textContent: 'Flow History', style: 'margin-bottom:12px' }));

    var history = data.history || [];
    if (history.length === 0) {
      panel.appendChild(h('div', { className: 'empty-state', textContent: 'No flow history found.' }));
      body.appendChild(panel);
      return;
    }

    var table = h('table', { className: 'data-table' });
    var thead = h('thead', null,
      h('tr', null,
        h('th', { textContent: 'Chat ID' }),
        h('th', { textContent: 'Flow Name' }),
        h('th', { textContent: 'Status' }),
        h('th', { textContent: 'Final Step' }),
        h('th', { textContent: 'Started' }),
        h('th', { textContent: 'Completed' })
      )
    );
    table.appendChild(thead);

    var tbody = h('tbody');
    for (var r of history) {
      tbody.appendChild(h('tr', null,
        h('td', { textContent: r.chat_id || '-' }),
        h('td', { textContent: r.flow_name || '-' }),
        h('td', null, h('span', { className: 'status ' + statusClass(r.status || 'unknown'), textContent: r.status || '-' })),
        h('td', { textContent: r.final_step || '-' }),
        h('td', { textContent: fmtTime(r.started_at) }),
        h('td', { textContent: fmtTime(r.completed_at) })
      ));
    }
    table.appendChild(tbody);
    panel.appendChild(table);

    // Pagination
    var total = data.total || 0;
    if (total > 0) {
      var pag = h('div', { className: 'pagination' },
        h('span', { textContent: 'Showing ' + (histOffset + 1) + '-' + Math.min(histOffset + history.length, total) + ' of ' + total })
      );
      if (histOffset > 0) {
        pag.appendChild(h('button', { className: 'btn', textContent: 'Previous', onClick: function() { histOffset = Math.max(0, histOffset - histLimit); loadHistory(); } }));
      }
      if (histOffset + histLimit < total) {
        pag.appendChild(h('button', { className: 'btn', textContent: 'Next', onClick: function() { histOffset += histLimit; loadHistory(); } }));
      }
      panel.appendChild(pag);
    }
    body.appendChild(panel);
  }

  await loadHistory();
}

// ── Usage tab ────────────────────────────────────────────────────
async function renderUsage(gen) {
  var content = document.getElementById('tab-content');
  clear(content);

  var currentWindow = '24h';

  async function load(win) {
    currentWindow = win;
    clear(content);

    // Window selector
    var selector = h('div', { className: 'window-select', style: 'margin-bottom:16px' });
    var windows = ['1h', '24h', '7d', '30d'];
    for (var i = 0; i < windows.length; i++) {
      (function(w) {
        selector.appendChild(h('button', {
          className: 'window-btn' + (w === currentWindow ? ' active' : ''),
          textContent: w,
          onClick: function() { load(w); }
        }));
      })(windows[i]);
    }
    content.appendChild(selector);
    content.appendChild(h('div', { className: 'loading', textContent: 'Loading usage data...' }));

    try {
      var res = await api('/instances/' + encodeURIComponent(state.instance) + '/usage?window=' + win);
      if (gen !== state.routeGeneration) return;
      if (res.status !== 200) {
        // Remove loading
        var loading = content.querySelector('.loading');
        if (loading) loading.remove();
        content.appendChild(h('div', { className: 'notify notify-error', textContent: (res.data && res.data.error) || 'Failed to load usage' }));
        return;
      }
      paintUsage(res.data, selector);
    } catch (e) {
      if (e.name === 'AbortError') return;
      var ld = content.querySelector('.loading');
      if (ld) ld.remove();
      content.appendChild(h('div', { className: 'notify notify-error', textContent: 'Error: ' + e.message }));
    }
  }

  function paintUsage(data, selector) {
    clear(content);
    content.appendChild(selector);

    var usage = data.usage || {};

    if (!data.data_available) {
      content.appendChild(h('div', { className: 'empty-state', textContent: 'No usage data available for this window.' }));
      return;
    }

    var grid = h('div', { className: 'usage-grid' });
    var stats = [
      { label: 'Input Tokens', value: fmtNum(usage.input_tokens) },
      { label: 'Output Tokens', value: fmtNum(usage.output_tokens) },
      { label: 'Total Tokens', value: fmtNum(usage.total_tokens) },
      { label: 'Requests', value: fmtNum(usage.request_count) },
    ];
    for (var s of stats) {
      grid.appendChild(h('div', { className: 'usage-stat' },
        h('div', { className: 'usage-stat-label', textContent: s.label }),
        h('div', { className: 'usage-stat-value', textContent: s.value })
      ));
    }
    content.appendChild(grid);
  }

  await load(currentWindow);
}

// ── Health status ────────────────────────────────────────────────
async function refreshHealth() {
  try {
    var resp = await fetch('/api/health');
    var data = await resp.json();
    var el = document.getElementById('health-status');
    if (el) {
      el.textContent = data.status === 'ok' ? 'API: Connected' : 'API: Error';
      el.style.color = data.status === 'ok' ? 'var(--green)' : 'var(--red)';
    }
  } catch (e) {
    var el = document.getElementById('health-status');
    if (el) { el.textContent = 'API: Disconnected'; el.style.color = 'var(--red)'; }
  }
}

// ── Init ─────────────────────────────────────────────────────────
route();
refreshHealth();
setInterval(refreshHealth, 15000);
</script>
</body>
</html>
